name: PETSc GMRES Solver CI/CD

on:
  push:  # Run on pushes to all branches
  pull_request:  # Run on PRs to all branches

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake make mpich libpetsc-real-dev pkg-config

    - name: Build project
      run: |
        chmod +x scripts/build.sh
        # Clean build directory to avoid CMake cache issues
        rm -rf build
        bash scripts/build.sh

    - name: Run solver
      run: |
        cd build
        mpirun -np 2 ./petsc_solver -n 100 -ksp_monitor -ksp_converged_reason

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: petsc-solver-binaries
        path: |
          build/petsc_solver

  benchmark:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake make mpich libpetsc-real-dev pkg-config

    - name: Build project
      run: |
        chmod +x scripts/build.sh
        # Clean build directory to avoid CMake cache issues
        rm -rf build
        bash scripts/build.sh

    - name: Run benchmarks
      run: |
        cd build
        echo "Running benchmark with different matrix sizes..."
        for size in 100 500 1000; do
          echo "Testing matrix size: $size"
          mpirun -np 4 ./petsc_solver -n $size -ksp_monitor | grep -E "(Iterations|Solve time|residual)"
        done

    - name: Generate benchmark report
      run: |
        echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo "- Build: PASSED" >> $GITHUB_STEP_SUMMARY
        echo "- Solver execution: PASSED" >> $GITHUB_STEP_SUMMARY
name: PETSc GMRES Solver CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'  # Run every Sunday at 2 AM

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mpich: ['3.4']
        petsc: ['3.18']

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc gfortran cmake make python3-dev python3-pip

    - name: Install MPICH
      run: |
        wget http://www.mpich.org/static/downloads/${{ matrix.mpich }}/mpich-${{ matrix.mpich }}.tar.gz
        tar -xzf mpich-${{ matrix.mpich }}.tar.gz
        cd mpich-${{ matrix.mpich }}
        ./configure --prefix=/usr/local --disable-fortran
        make -j2
        sudo make install
        which mpicc

    - name: Install PETSc
      run: |
        git clone -b release https://gitlab.com/petsc/petsc.git
        cd petsc
        ./configure --with-cc=mpicc --with-cxx=mpicxx \
                    --download-f2cblaslapack --download-mpich --with-debugging=0
        make all
        echo "PETSC_DIR=$(pwd)" >> $GITHUB_ENV
        echo "PETSC_ARCH=arch-linux-c-debug" >> $GITHUB_ENV

    - name: Build project with Make
      run: |
        make PETSC_DIR=$PETSC_DIR PETSC_ARCH=$PETSC_ARCH

    - name: Build project with CMake
      run: |
        mkdir build && cd build
        cmake -DPETSC_DIR=$PETSC_DIR -DPETSC_ARCH=$PETSC_ARCH ..
        make -j2

    - name: Run basic tests
      run: |
        mpirun -np 2 ./test_solver -ksp_monitor -ksp_converged_reason

    - name: Run solver tests
      run: |
        echo "Testing different matrix sizes..."
        for size in 100 500; do
          echo "Size: $size"
          mpirun -np 2 ./petsc_solver -n $size -ksp_monitor | grep "Solve time"
        done

    - name: Run examples
      run: |
        make examples PETSC_DIR=$PETSC_DIR PETSC_ARCH=$PETSC_ARCH
        mpirun -np 2 examples/poisson2d -nx 20 -ny 20 -ksp_monitor

    - name: Run Python tests
      run: |
        pip3 install -r requirements.txt
        python3 scripts/generate_matrices.py --type laplace1d --size 50
        python3 scripts/generate_matrices.py --type laplace2d --nx 5 --ny 5

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: petsc-solver-binaries
        path: |
          petsc_solver
          test_solver
          examples/

  benchmark:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: petsc-solver-binaries
        path: .

    - name: Set up benchmark environment
      run: |
        sudo apt-get update
        sudo apt-get install -y mpich libopenblas-dev
        pip3 install matplotlib pandas scipy

    - name: Run benchmarks
      run: |
        chmod +x scripts/run_benchmarks.sh
        ./scripts/run_benchmarks.sh --compare

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: benchmark_results/

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Check code formatting
      run: |
        # Check for trailing whitespace
        if git grep -n "[[:space:]]$" -- '*.c' '*.h'; then
          echo "Error: Trailing whitespace found"
          exit 1
        fi
        
        # Check for tab characters
        if git grep -n "$(printf '\t')" -- '*.c' '*.h'; then
          echo "Error: Tab characters found, use spaces instead"
          exit 1
        fi

    - name: Check documentation
      run: |
        # Check if README exists and has content
        if [ ! -s README.md ]; then
          echo "Error: README.md is empty or missing"
          exit 1
        fi
        
        # Check if key files exist
        for file in Makefile CMakeLists.txt .gitignore; do
          if [ ! -f "$file" ]; then
            echo "Error: $file is missing"
            exit 1
          fi
        done

  docker-build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: |
        docker build -t petsc-gmres-solver:latest .

    - name: Test Docker image
      run: |
        docker run --rm petsc-gmres-solver:latest ./petsc_solver -n 100 -ksp_monitor

    - name: Push to GitHub Packages
      uses: docker/build-push-action@v2
      with:
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:${{ github.sha }}

  release:
    runs-on: ubuntu-latest
    needs: [build-and-test, benchmark, code-quality]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: petsc-solver-binaries
        path: .

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          petsc_solver
          test_solver
          examples/*
        draft: false
        prerelease: false